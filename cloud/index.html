<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Cloud support - pipen</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="//use.fontawesome.com/releases/v5.8.1/css/all.css" rel="stylesheet" />
        <link href="//use.fontawesome.com/releases/v5.8.1/css/v4-shims.css" rel="stylesheet" />
        <link href="../css/mkapi-common.css" rel="stylesheet" />
        <link href="../assets/style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Cloud support";
        var mkdocs_page_input_path = "cloud.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.configure({ ignoreUnescapedHTML: true }); hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../rtd-logo.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="nav-scrollable-wrapper">
      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Introduction</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="..">Overview</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tutorials</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../tutorials/beginner/">Beginner Tutorial</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../defining-proc/">Defining a process</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../running/">Defining and running a pipeline</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">How-to Guides</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../templating/">Templating</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../channels/">Channels</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../input-output/">Input and output</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../script/">Script</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../caching/">Caching</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Cloud support</a>
    <ul class="current">
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../error/">Error handling</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../configurations/">Configurations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../plugin/">Plugins</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../scheduler/">Scheduler</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../proc-group/">Process group</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../cli/">Command line interface</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">API</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="#">pipen</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen/">pipen</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.pluginmgr/">pipen.pluginmgr</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.utils/">pipen.utils</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.proc/">pipen.proc</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.version/">pipen.version</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.job/">pipen.job</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.scheduler/">pipen.scheduler</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.exceptions/">pipen.exceptions</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.pipen/">pipen.pipen</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.channel/">pipen.channel</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.progressbar/">pipen.progressbar</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.template/">pipen.template</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.procgroup/">pipen.procgroup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.defaults/">pipen.defaults</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">pipen.cli</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.cli/">pipen.cli</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.cli.profile/">pipen.cli.profile</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.cli.version/">pipen.cli.version</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.cli.help/">pipen.cli.help</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../api/pipen.cli.plugins/">pipen.cli.plugins</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../examples/">Examples</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CHANGELOG/">Change Log</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../CONTRIBUTING/">Contributing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../glossary/">Glossary</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Explanation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../architecture/">Architecture</a>
                  </li>
              </ul>
      </div>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">pipen</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">How-to Guides</li>
      <li class="breadcrumb-item active">Cloud support</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/pwwang/pipen/blob/master/docs/cloud.md">Edit on pwwang/pipen</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <p>Since <code>v0.16.0</code>, <code>pipen</code> supports the cloud naively. There are two ways by means of cloud support:</p>
<ul>
<li>Run the pipeline locally (or schedulers like <code>sge</code>, <code>slurm</code>, etc.) and save the files to the cloud.</li>
<li>Run the pipeline on the cloud.</li>
</ul>
<h3 id="run-the-pipeline-locally-and-save-the-files-to-the-cloud">Run the pipeline locally and save the files to the cloud<a class="headerlink" href="#run-the-pipeline-locally-and-save-the-files-to-the-cloud" title="Permanent link">&para;</a></h3>
<p>To run the pipeline locally and save the files to the cloud, you need to install <code>pipen</code> with cloud support:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>xqute<span class="o">[</span>cloudsh<span class="o">]</span>
<span class="c1"># To support a specific cloud service provider</span>
pip<span class="w"> </span>install<span class="w"> </span>cloudpathlib<span class="o">[</span>s3<span class="o">]</span>
pip<span class="w"> </span>install<span class="w"> </span>cloudpathlib<span class="o">[</span>gs<span class="o">]</span>
pip<span class="w"> </span>install<span class="w"> </span>cloudpathlib<span class="o">[</span>azure<span class="o">]</span>
</code></pre></div>
<p>The you can directly assign a cloud path as a pipeline working directory:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pipen</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipen</span><span class="p">,</span> <span class="n">Proc</span><span class="p">,</span> <span class="n">run</span>


<span class="k">class</span><span class="w"> </span><span class="nc">P1</span><span class="p">(</span><span class="n">Proc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort input file&quot;&quot;&quot;</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;in:var&quot;</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hello World&quot;</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;outfile:file:out.txt&quot;</span>
    <span class="c1"># Note that out.outfile is on the cloud but the script is executed locally</span>
    <span class="c1"># we can use cloudsh to save the output to the cloud</span>
    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;echo {{in.in}} | cloudsh sink {{out.outfile}}&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyPipeline</span><span class="p">(</span><span class="n">Pipen</span><span class="p">):</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="s2">&quot;gs://mybucket/mypipeline/workdir&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;gs://mybucket/mypipeline/output&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">MyPipeline</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>Like the following figure, the pipeline is run locally but the meta information is grabbed from and saved to the cloud (workdir).
No local files are generated.</p>
<p>For the output files, if a process is a non-export process, the output files are saved to the workdir.
If a process is an export process, the output files are saved to the output directory (export dir).</p>
<p><img alt="Architecture diagram showing how pipen runs pipelines on Google Cloud Batch, with pipeline definitions uploaded to cloud storage and jobs submitted as batch jobs with automatic status tracking." src="../pipen-cloud1.png" /></p>
<h3 id="run-the-pipeline-on-the-cloud">Run the pipeline on the cloud<a class="headerlink" href="#run-the-pipeline-on-the-cloud" title="Permanent link">&para;</a></h3>
<p>Currently, <code>pipen</code> only supports running the pipeline on the cloud with google batch jobs.</p>
<p>To run the pipeline on the cloud, you need to install <code>pipen</code> with cloud support:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>xqute<span class="o">[</span>gs<span class="o">]</span>
</code></pre></div>
<p>It is used to communicate with google cloud storage files. No <code>cloudsh</code> is needed, since operating the cloud files will be happening on the cloud (with the cloud paths mounted to the VM). You also need to have <a href="https://cloud.google.com/sdk?hl=en">google cloud sdk</a> installed and configured, which is used to communicate with google batch jobs (submit jobs, get job status, etc.).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pipen</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipen</span><span class="p">,</span> <span class="n">Proc</span><span class="p">,</span> <span class="n">run</span>


<span class="k">class</span><span class="w"> </span><span class="nc">P1</span><span class="p">(</span><span class="n">Proc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sort input file&quot;&quot;&quot;</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="s2">&quot;in:var&quot;</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hello World&quot;</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;outfile:file:out.txt&quot;</span>
    <span class="c1"># Note that out.outfile is on the cloud but the script is executed locally</span>
    <span class="c1"># we can use cloudsh to save the output to the cloud</span>
    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;echo {{in.in}} | cloudsh sink {{out.outfile}}&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyPipeline</span><span class="p">(</span><span class="n">Pipen</span><span class="p">):</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">P1</span>
    <span class="n">workdir</span> <span class="o">=</span> <span class="s2">&quot;gs://mybucket/mypipeline/workdir&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;gs://mybucket/mypipeline/output&quot;</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="s2">&quot;gbatch&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">MyPipeline</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div>
<p>The only difference is that we need to set <code>scheduler</code> to <code>gbatch</code> (google batch jobs).</p>
<p>As shown in the following figure, the pipeline is run on the cloud platform, and the workdir and export dir will be mounted to the VM. So the process script can directly access the cloud files, no <code>cloudsh</code> or <code>gcloud</code> tools are needed.</p>
<p><img alt="Cloud execution diagram showing pipeline workdir and output directory mounted to a Google Cloud VM instance, with the process script accessing cloud files directly and pipen managing metadata through cloudpathlib's cache mechanism." src="../pipen-cloud2.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>While the workdir and output dir are on the cloud, <code>pipen</code> needs to communicate with the cloud storage to get and save the meta information of the pipeline (workdir) and also upload/download files if needed. We are using <a href="https://github.com/pwwang/yunpath"><code>yunpath</code></a> to manage the cloud paths, which is a wrapper of <a href="https://github.com/drivendataorg/cloudpathlib"><code>cloudpathlib</code></a>. <code>cloudpathlib</code> uses a cache mechanism to reduce the communication with the cloud storage, which can greatly improve the performance. If you are running into issues with the local cache (e.g. no space left), you can set the environment variable <code>CLOUDPATHLIB_LOCAL_CACHE_DIR</code> to change the cache directory. See more details in the <a href="https://cloudpathlib.drivendata.org/stable/caching/"><code>cloudpathlib</code> documentation</a>.</p>
</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../caching/" class="btn btn-neutral float-left" title="Caching"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../error/" class="btn btn-neutral float-right" title="Error handling">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  <div class="footer-notes">
    <a href="https://github.com/pwwang/pipen" title="Open repository in GitHub">Github Repo</a>
    <div class="footer-sep"></div>Built with <a href="https://www.mkdocs.org/">MkDocs</a> using theme <a href="https://github.com/pwwang/mkdocs-rtd">mkdocs-rtd</a>.
  </div>
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../caching/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../error/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/version-select.js"></script>
      <script src="../js/mkapi.js"></script>
      <script src="../assets/script.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
